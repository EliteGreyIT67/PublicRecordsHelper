<!DOCTYPE html>
<html lang="en" x-data="publicRecordsApp" x-init="init()" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Records Request Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .form-legend { @apply text-xl font-bold mb-4 text-gray-800 dark:text-white flex items-center; }
        .form-label { @apply block text-sm font-medium mb-1 text-gray-600 dark:text-gray-300; }
        .form-input, .form-select, .form-textarea { @apply w-full px-4 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 transition-all duration-200 shadow-sm; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { @apply ring-2 ring-blue-500 border-transparent shadow-lg; }
        .action-button { @apply px-5 py-2.5 rounded-lg text-sm font-semibold text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-offset-2; }
        .dark-mode-toggle { @apply bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300; }
        .dark-mode-toggle:hover { transform: scale(1.1) rotate(20deg); }
        .letter-content { font-family: 'Tinos', 'Times New Roman', serif; line-height: 1.7; }
        .dark::-webkit-scrollbar { width: 12px; }
        .dark::-webkit-scrollbar-track { background: #1f2937; }
        .dark::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 6px; border: 2px solid #1f2937; }
        .dark::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        html.dark { scrollbar-color: #4b5563 #1f2937; scrollbar-width: auto; }
        .notification { animation: slideInRight 0.5s ease-out forwards, fadeOut 0.5s ease-in forwards 4.5s; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body x-cloak class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-4">
                    <i class="fas fa-file-invoice text-3xl text-blue-600 dark:text-blue-400"></i>
                    <div>
                        <h1 class="text-2xl font-bold" x-text="t('appTitle')"></h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400" x-text="t('appSubtitle')"></p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <select x-model="currentLang" @change="setLang($event.target.value)" class="form-select !w-auto !py-2.5 !pl-10 !pr-5 text-sm appearance-none">
                            <option value="en">English</option>
                            <option value="es">Español</option>
                        </select>
                        <i class="fas fa-globe absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button @click="toggleDarkMode()" class="dark-mode-toggle" :aria-label="t('toggleDarkMode')">
                        <i class="fas text-xl" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i>
                    </button>
                    <button @click="confirmStartOver()" class="action-button bg-red-600 hover:bg-red-700 focus:ring-red-500">
                        <i class="fas fa-sync-alt mr-2"></i><span x-text="t('startOver')"></span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <!-- Form Section -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 space-y-10">
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white border-b-2 pb-5 border-gray-200 dark:border-gray-700" x-text="t('requestDetails')"></h2>
                
                <fieldset>
                    <legend class="form-legend"><i class="fas fa-landmark mr-3 text-blue-500"></i><span x-text="t('jurisdiction')"></span></legend>
                    <label for="state-select" class="form-label" x-text="t('selectState')"></label>
                    <select id="state-select" x-model="form.state" @change="onStateChange()" class="form-select">
                        <option value="" x-text="t('chooseState')"></option>
                        <template x-for="law in laws" :key="law.code"><option :value="law.code" x-text="`${law.name} (${law.code})`"></option></template>
                    </select>
                </fieldset>

                <fieldset>
                    <legend class="form-legend"><i class="fas fa-file-lines mr-3 text-purple-500"></i><span x-text="t('requestTemplate')"></span></legend>
                    <div class="flex items-center justify-between mb-3">
                        <label for="template-select" class="form-label" x-text="t('quickStartTemplates')"></label>
                        <button @click="openTemplateWizard()" class="action-button bg-purple-600 hover:bg-purple-700 text-sm focus:ring-purple-500">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i><span x-text="t('createCustom')"></span>
                        </button>
                    </div>
                    <select id="template-select" x-model="selectedTemplate" @change="applyTemplate()" class="form-select">
                        <option value="" x-text="t('selectTemplate')"></option>
                        <optgroup :label="t('builtInTemplates')">
                            <template x-for="template in templates" :key="template.id"><option :value="template.id" x-text="t(template.id, template.name)"></option></template>
                        </optgroup>
                        <template x-if="customTemplates.length > 0">
                            <optgroup :label="t('myCustomTemplates')">
                                <template x-for="template in customTemplates" :key="template.id"><option :value="'custom_' + template.id" x-text="template.name"></option></template>
                            </optgroup>
                        </template>
                    </select>
                </fieldset>
                
                <fieldset class="pt-8 border-t-2 border-gray-200 dark:border-gray-700">
                    <legend class="form-legend"><i class="fas fa-user-edit mr-3 text-green-500"></i><span x-text="t('yourInformation')"></span></legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="requesterName" class="form-label" x-text="t('fullName')"></label><input id="requesterName" type="text" x-model="form.requesterName" :placeholder="t('fullNamePlaceholder')" class="form-input" required></div>
                        <div><label for="requesterEmail" class="form-label" x-text="t('emailAddress')"></label><input id="requesterEmail" type="email" x-model="form.requesterEmail" :placeholder="t('emailAddressPlaceholder')" class="form-input" required></div>
                        <div><label for="requesterPhone" class="form-label" x-text="t('phoneNumber')"></label><input id="requesterPhone" type="tel" x-model="form.requesterPhone" :placeholder="t('phoneNumberPlaceholder')" class="form-input"></div>
                        <div><label for="requesterOrganization" class="form-label" x-text="t('organization')"></label><input id="requesterOrganization" type="text" x-model="form.requesterOrganization" :placeholder="t('organizationPlaceholder')" class="form-input"></div>
                    </div>
                    <div class="mt-6"><label for="requesterAddress" class="form-label" x-text="t('mailingAddress')"></label><textarea id="requesterAddress" x-model="form.requesterAddress" :placeholder="t('mailingAddressPlaceholder')" rows="3" class="form-textarea"></textarea></div>
                </fieldset>
            </div>

            <!-- Preview Section -->
            <div class="sticky top-28 h-fit">
                <div class="rounded-2xl shadow-xl p-8 bg-white dark:bg-gray-800">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white" x-text="t('previewExport')"></h2>
                        <div class="flex gap-3">
                            <button @click="copyToClipboard()" :title="t('copyAsText')" class="action-button bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"><i class="fas fa-copy"></i></button>
                            <button @click="exportAsText()" :title="t('downloadAsTXT')" class="action-button bg-green-600 hover:bg-green-700 focus:ring-green-500"><i class="fas fa-file-alt"></i></button>
                            <button @click="exportAsPDF()" :title="t('exportAsPDF')" class="action-button bg-red-600 hover:bg-red-700 focus:ring-red-500"><i class="fas fa-file-pdf"></i></button>
                        </div>
                    </div>
                    
                    <div id="letterPreviewContainer" class="border-2 rounded-lg h-[75vh] overflow-y-auto bg-gray-50 dark:bg-gray-900/50 border-gray-200 dark:border-gray-700">
                        <div id="letterPreview" class="p-8 text-gray-800 dark:text-gray-200">
                            <div class="letter-content" x-html="generateLetterHTML()">
                                <!-- Letter content is dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification Area -->
    <div aria-live="assertive" class="fixed inset-0 flex items-end px-4 py-6 pointer-events-none sm:p-6 sm:items-start z-50">
        <div class="w-full flex flex-col items-center space-y-4 sm:items-end">
            <template x-for="notification in notifications" :key="notification.id">
                <div x-show="notification.visible" x-transition:enter="transform ease-out duration-300 transition" x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2" x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0" x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="max-w-sm w-full bg-white dark:bg-gray-700 shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas" :class="{ 'fa-check-circle text-green-400': notification.type === 'success', 'fa-exclamation-circle text-red-400': notification.type === 'error', 'fa-info-circle text-blue-400': notification.type === 'info' }"></i>
                            </div>
                            <div class="ml-3 w-0 flex-1 pt-0.5">
                                <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="notification.message"></p>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex">
                                <button @click="notification.visible = false" class="bg-white dark:bg-gray-700 rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <span class="sr-only">Close</span>
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div x-show="confirmModal.open" x-cloak class="fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="confirmModal.open" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div x-show="confirmModal.open" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title" x-text="confirmModal.title"></h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400" x-text="confirmModal.body"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="confirmModal.onConfirm(); confirmModal.open = false" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white sm:ml-3 sm:w-auto sm:text-sm" :class="confirmModal.confirmClass" x-text="confirmModal.confirmText"></button>
                    <button @click="confirmModal.open = false" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('publicRecordsApp', () => ({
                // --- STATE PROPERTIES --- //
                form: {},
                darkMode: false,
                laws: [],
                templates: [],
                customTemplates: [],
                selectedTemplate: '',
                selectedLaw: null,
                notifications: [],
                notificationCounter: 0,
                confirmModal: { open: false, title: '', body: '', onConfirm: () => {}, confirmText: 'Confirm', confirmClass: 'bg-red-600 hover:bg-red-700' },
                showTemplateWizard: false,
                customTemplate: {},
                currentLang: 'en',
                locales: {},

                // --- INITIALIZATION --- //
                init() {
                    this.resetForm();
                    this.resetCustomTemplate();
                    this.loadData();
                    this.initLanguage();
                    this.initDarkMode();
                    this.loadCustomTemplatesFromStorage();
                    this.$watch('form', () => this.updatePreview(), { deep: true });
                    this.updatePreview();
                    console.log("Public Records Helper Initialized.");
                },

                resetForm() {
                    this.form = {
                        requesterName: '', requesterEmail: '', requesterPhone: '',
                        requesterOrganization: '', requesterAddress: '', state: '',
                        agencyName: '', agencyDepartment: '', agencyContact: '',
                        agencyAddress: '', subject: '', recordsDescription: '',
                        dateFrom: '', dateTo: '', preferredFormat: 'electronic',
                        expeditedProcessing: false, feeWaiverRequest: false, additionalNotes: ''
                    };
                    this.selectedTemplate = '';
                    this.selectedLaw = null;
                },

                loadData() {
                    // Inlined data for simplicity
                    this.locales = {
                        en: {"appTitle":"Public Records Request Generator","appSubtitle":"Craft professional requests with state-specific legal citations.","requestDetails":"Request Details","jurisdiction":"Jurisdiction","selectState":"Select Your State (Required)","chooseState":"Choose your state...","requestTemplate":"Request Template","quickStartTemplates":"Quick Start Templates","createCustom":"Create Custom","selectTemplate":"Select a template...","builtInTemplates":"Built-in Templates","myCustomTemplates":"My Custom Templates","yourInformation":"Your Information","fullName":"Full Name *","fullNamePlaceholder":"John Doe","emailAddress":"Email Address *","emailAddressPlaceholder":"john@example.com","phoneNumber":"Phone Number","phoneNumberPlaceholder":"(555) 123-4567","organization":"Organization (if applicable)","organizationPlaceholder":"News Organization","mailingAddress":"Mailing Address","mailingAddressPlaceholder":"123 Main St, City, State 12345","previewExport":"Preview & Export","copyAsText":"Copy as Text","downloadAsTXT":"Download as TXT","exportAsPDF":"Export as PDF","startOver":"Start Over","toggleDarkMode":"Toggle Dark Mode","police_report":"Police Report","animal_welfare":"Animal Welfare Records","government_contracts":"Government Contracts","financial_records":"Financial Records","meeting_records":"Meeting Records","employment_records":"Employment Records","property_records":"Property Records","permits_licenses":"Permits and Licenses"},
                        es: {"appTitle":"Generador de Solicitudes de Registros Públicos","appSubtitle":"Cree solicitudes profesionales con citas legales específicas del estado.","requestDetails":"Detalles de la Solicitud","jurisdiction":"Jurisdicción","selectState":"Seleccione su Estado (Requerido)","chooseState":"Elija su estado...","requestTemplate":"Plantilla de Solicitud","quickStartTemplates":"Plantillas Rápidas","createCustom":"Crear Personalizada","selectTemplate":"Seleccione una plantilla...","builtInTemplates":"Plantillas Incorporadas","myCustomTemplates":"Mis Plantillas Personalizadas","yourInformation":"Su Información","fullName":"Nombre Completo *","fullNamePlaceholder":"Juan Pérez","emailAddress":"Correo Electrónico *","emailAddressPlaceholder":"juan@ejemplo.com","phoneNumber":"Número de Teléfono","phoneNumberPlaceholder":"(555) 123-4567","organization":"Organización (si aplica)","organizationPlaceholder":"Organización de Noticias","mailingAddress":"Dirección Postal","mailingAddressPlaceholder":"123 Calle Principal, Ciudad, Estado 12345","previewExport":"Vista Previa y Exportar","copyAsText":"Copiar como Texto","downloadAsTXT":"Descargar como TXT","exportAsPDF":"Exportar como PDF","startOver":"Empezar de Nuevo","toggleDarkMode":"Alternar Modo Oscuro","police_report":"Informe de Policía","animal_welfare":"Registros de Bienestar Animal","government_contracts":"Contratos Gubernamentales","financial_records":"Registros Financieros","meeting_records":"Actas de Reuniones","employment_records":"Registros de Empleo","property_records":"Registros de Propiedad","permits_licenses":"Permisos y Licencias"}
                    };
                    this.laws = [
                      { "code": "AL", "name": "Alabama", "lawName": "Alabama Open Records Act", "citation": "Code of Alabama § 36-12-40 et seq.", "fullCitation": "the Alabama Open Records Act (Code of Alabama § 36-12-40 et seq.)", "responseTime": "2-5 business days for acknowledgment; 15-35 business days for response", "denialProcess": "If any portion of this request is denied, the agency must cite the specific legal authority for the denial and advise you of your appeal rights." },
                      { "code": "AK", "name": "Alaska", "lawName": "Alaska Public Records Act", "citation": "AS 40.25.110 et seq.", "fullCitation": "the Alaska Public Records Act (AS 40.25.110 et seq.)", "responseTime": "10 business days", "denialProcess": "Denials must include the specific statutory basis and information about appeal rights." },
                      { "code": "AZ", "name": "Arizona", "lawName": "Arizona Public Records Law", "citation": "A.R.S. § 39-121 et seq.", "fullCitation": "the Arizona Public Records Law (A.R.S. § 39-121 et seq.)", "responseTime": "No specific timeframe", "denialProcess": "Denials must cite specific statutory exemptions and inform requester of appeal rights." },
                      { "code": "AR", "name": "Arkansas", "lawName": "Arkansas Freedom of Information Act", "citation": "Ark. Code Ann. § 25-19-101 et seq.", "fullCitation": "the Arkansas Freedom of Information Act (Ark. Code Ann. § 25-19-101 et seq.)", "responseTime": "3 business days", "denialProcess": "Written denials must cite specific exemptions and include information about appeal process." },
                      { "code": "CA", "name": "California", "lawName": "California Public Records Act", "citation": "Gov. Code § 6250 et seq.", "fullCitation": "the California Public Records Act (Gov. Code § 6250 et seq.)", "responseTime": "10 days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to petition for writ of mandate." },
                      { "code": "CO", "name": "Colorado", "lawName": "Colorado Open Records Act", "citation": "C.R.S. § 24-72-200.1 et seq.", "fullCitation": "the Colorado Open Records Act (C.R.S. § 24-72-200.1 et seq.)", "responseTime": "3 business days", "denialProcess": "Written denials must cite specific statutory grounds and inform requester of right to seek court review." },
                      { "code": "CT", "name": "Connecticut", "lawName": "Connecticut Freedom of Information Act", "citation": "Conn. Gen. Stat. § 1-200 et seq.", "fullCitation": "the Connecticut Freedom of Information Act (Conn. Gen. Stat. § 1-200 et seq.)", "responseTime": "4 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to appeal to Freedom of Information Commission." },
                      { "code": "DE", "name": "Delaware", "lawName": "Delaware Freedom of Information Act", "citation": "29 Del. C. § 10001 et seq.", "fullCitation": "the Delaware Freedom of Information Act (29 Del. C. § 10001 et seq.)", "responseTime": "15 business days", "denialProcess": "Denials must specify legal grounds and inform requester of right to seek court review." },
                      { "code": "FL", "name": "Florida", "lawName": "Florida Public Records Act", "citation": "Fla. Stat. § 119.01 et seq.", "fullCitation": "the Florida Public Records Act (Fla. Stat. § 119.01 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific statutory exemptions. Requester may seek mandamus action." },
                      { "code": "GA", "name": "Georgia", "lawName": "Georgia Open Records Act", "citation": "O.C.G.A. § 50-18-70 et seq.", "fullCitation": "the Georgia Open Records Act (O.C.G.A. § 50-18-70 et seq.)", "responseTime": "3 business days", "denialProcess": "Denials must cite specific exemptions and may be appealed to superior court." },
                      { "code": "HI", "name": "Hawaii", "lawName": "Hawaii Uniform Information Practices Act", "citation": "HRS § 92F-1 et seq.", "fullCitation": "the Hawaii Uniform Information Practices Act (HRS § 92F-1 et seq.)", "responseTime": "10 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to appeal to the Office of Information Practices." },
                      { "code": "ID", "name": "Idaho", "lawName": "Idaho Public Records Act", "citation": "Idaho Code § 74-101 et seq.", "fullCitation": "the Idaho Public Records Act (Idaho Code § 74-101 et seq.)", "responseTime": "3-10 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to petition for judicial review." },
                      { "code": "IL", "name": "Illinois", "lawName": "Illinois Freedom of Information Act", "citation": "5 ILCS 140/1 et seq.", "fullCitation": "the Illinois Freedom of Information Act (5 ILCS 140/1 et seq.)", "responseTime": "5 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek review by the Public Access Counselor." },
                      { "code": "IN", "name": "Indiana", "lawName": "Indiana Access to Public Records Act", "citation": "IC 5-14-3-1 et seq.", "fullCitation": "the Indiana Access to Public Records Act (IC 5-14-3-1 et seq.)", "responseTime": "24 hours", "denialProcess": "Denials must cite specific exemptions and inform requester of right to file a complaint with the Public Access Counselor." },
                      { "code": "IA", "name": "Iowa", "lawName": "Iowa Open Records Act", "citation": "Iowa Code Chapter 22", "fullCitation": "the Iowa Open Records Act (Iowa Code Chapter 22)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "KS", "name": "Kansas", "lawName": "Kansas Open Records Act", "citation": "K.S.A. 45-215 et seq.", "fullCitation": "the Kansas Open Records Act (K.S.A. 45-215 et seq.)", "responseTime": "3 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "KY", "name": "Kentucky", "lawName": "Kentucky Open Records Act", "citation": "KRS 61.870 et seq.", "fullCitation": "the Kentucky Open Records Act (KRS 61.870 et seq.)", "responseTime": "3 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to appeal to the Attorney General." },
                      { "code": "LA", "name": "Louisiana", "lawName": "Louisiana Public Records Act", "citation": "La. R.S. 44:1 et seq.", "fullCitation": "the Louisiana Public Records Act (La. R.S. 44:1 et seq.)", "responseTime": "3 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "ME", "name": "Maine", "lawName": "Maine Freedom of Access Act", "citation": "1 M.R.S. § 401 et seq.", "fullCitation": "the Maine Freedom of Access Act (1 M.R.S. § 401 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "MD", "name": "Maryland", "lawName": "Maryland Public Information Act", "citation": "GP § 4-101 et seq.", "fullCitation": "the Maryland Public Information Act (GP § 4-101 et seq.)", "responseTime": "30 days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to file complaint with Public Information Act Compliance Board." },
                      { "code": "MA", "name": "Massachusetts", "lawName": "Massachusetts Public Records Law", "citation": "M.G.L. c. 66 § 10 et seq.", "fullCitation": "the Massachusetts Public Records Law (M.G.L. c. 66 § 10 et seq.)", "responseTime": "10 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to appeal to the Supervisor of Public Records." },
                      { "code": "MI", "name": "Michigan", "lawName": "Michigan Freedom of Information Act", "citation": "MCL 15.231 et seq.", "fullCitation": "the Michigan Freedom of Information Act (MCL 15.231 et seq.)", "responseTime": "5 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "MN", "name": "Minnesota", "lawName": "Minnesota Government Data Practices Act", "citation": "Minn. Stat. § 13.01 et seq.", "fullCitation": "the Minnesota Government Data Practices Act (Minn. Stat. § 13.01 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "MS", "name": "Mississippi", "lawName": "Mississippi Public Records Act", "citation": "Miss. Code Ann. § 25-61-1 et seq.", "fullCitation": "the Mississippi Public Records Act (Miss. Code Ann. § 25-61-1 et seq.)", "responseTime": "7-14 working days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "MO", "name": "Missouri", "lawName": "Missouri Sunshine Law", "citation": "Mo. Rev. Stat. § 610.010 et seq.", "fullCitation": "the Missouri Sunshine Law (Mo. Rev. Stat. § 610.010 et seq.)", "responseTime": "3 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "MT", "name": "Montana", "lawName": "Montana Right to Know Act", "citation": "Mont. Code Ann. § 2-6-101 et seq.", "fullCitation": "the Montana Right to Know Act (Mont. Code Ann. § 2-6-101 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "NE", "name": "Nebraska", "lawName": "Nebraska Public Records Statutes", "citation": "Neb. Rev. Stat. § 84-712 et seq.", "fullCitation": "the Nebraska Public Records Statutes (Neb. Rev. Stat. § 84-712 et seq.)", "responseTime": "4 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "NV", "name": "Nevada", "lawName": "Nevada Public Records Act", "citation": "NRS 239.001 et seq.", "fullCitation": "the Nevada Public Records Act (NRS 239.001 et seq.)", "responseTime": "5 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "NH", "name": "New Hampshire", "lawName": "New Hampshire Right-to-Know Law", "citation": "RSA 91-A", "fullCitation": "the New Hampshire Right-to-Know Law (RSA 91-A)", "responseTime": "5 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to petition for injunctive relief." },
                      { "code": "NJ", "name": "New Jersey", "lawName": "New Jersey Open Public Records Act", "citation": "N.J.S.A. 47:1A-1 et seq.", "fullCitation": "the New Jersey Open Public Records Act (N.J.S.A. 47:1A-1 et seq.)", "responseTime": "7 business days", "denialProcess": "Denials must cite specific exemptions. The 2024 reforms make it more difficult to recover attorneys' fees in challenges and allow agencies to sue requesters." },
                      { "code": "NM", "name": "New Mexico", "lawName": "New Mexico Inspection of Public Records Act", "citation": "NMSA 1978 § 14-2-1 et seq.", "fullCitation": "the New Mexico Inspection of Public Records Act (NMSA 1978 § 14-2-1 et seq.)", "responseTime": "3 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "NY", "name": "New York", "lawName": "New York Freedom of Information Law", "citation": "Public Officers Law § 84 et seq.", "fullCitation": "the New York Freedom of Information Law (Public Officers Law § 84 et seq.)", "responseTime": "5 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to appeal to agency head and then seek Article 78 review." },
                      { "code": "NC", "name": "North Carolina", "lawName": "North Carolina Public Records Law", "citation": "N.C.G.S. § 132-1 et seq.", "fullCitation": "the North Carolina Public Records Law (N.C.G.S. § 132-1 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "ND", "name": "North Dakota", "lawName": "North Dakota Open Records Statute", "citation": "N.D.C.C. § 44-04-18 et seq.", "fullCitation": "the North Dakota Open Records Statute (N.D.C.C. § 44-04-18 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "OH", "name": "Ohio", "lawName": "Ohio Public Records Act", "citation": "Ohio Rev. Code § 149.43", "fullCitation": "the Ohio Public Records Act (Ohio Rev. Code § 149.43)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "OK", "name": "Oklahoma", "lawName": "Oklahoma Open Records Act", "citation": "51 O.S. § 24A.1 et seq.", "fullCitation": "the Oklahoma Open Records Act (51 O.S. § 24A.1 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "OR", "name": "Oregon", "lawName": "Oregon Public Records Law", "citation": "ORS 192.410 et seq.", "fullCitation": "the Oregon Public Records Law (ORS 192.410 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to petition for judicial review." },
                      { "code": "PA", "name": "Pennsylvania", "lawName": "Pennsylvania Right-to-Know Law", "citation": "65 P.S. § 67.101 et seq.", "fullCitation": "the Pennsylvania Right-to-Know Law (65 P.S. § 67.101 et seq.)", "responseTime": "5 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to appeal to the Office of Open Records." },
                      { "code": "RI", "name": "Rhode Island", "lawName": "Rhode Island Access to Public Records Act", "citation": "R.I.G.L. § 38-2-1 et seq.", "fullCitation": "the Rhode Island Access to Public Records Act (R.I.G.L. § 38-2-1 et seq.)", "responseTime": "10 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "SC", "name": "South Carolina", "lawName": "South Carolina Freedom of Information Act", "citation": "S.C. Code Ann. § 30-4-10 et seq.", "fullCitation": "the South Carolina Freedom of Information Act (S.C. Code Ann. § 30-4-10 et seq.)", "responseTime": "15 calendar days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "SD", "name": "South Dakota", "lawName": "South Dakota Sunshine Law", "citation": "SDCL § 1-27-1 et seq.", "fullCitation": "the South Dakota Sunshine Law (SDCL § 1-27-1 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "TN", "name": "Tennessee", "lawName": "Tennessee Public Records Act", "citation": "Tenn. Code Ann. § 10-7-501 et seq.", "fullCitation": "the Tennessee Public Records Act (Tenn. Code Ann. § 10-7-501 et seq.)", "responseTime": "7 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to petition for writ of mandamus." },
                      { "code": "TX", "name": "Texas", "lawName": "Texas Public Information Act", "citation": "Tex. Gov't Code § 552.001 et seq.", "fullCitation": "the Texas Public Information Act (Tex. Gov't Code § 552.001 et seq.)", "responseTime": "10 business days", "denialProcess": "Denials require Attorney General ruling on exceptions. Requester may appeal ruling to district court." },
                      { "code": "UT", "name": "Utah", "lawName": "Utah Government Records Access and Management Act", "citation": "Utah Code § 63G-2-101 et seq.", "fullCitation": "the Utah Government Records Access and Management Act (Utah Code § 63G-2-101 et seq.)", "responseTime": "10 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to appeal to the State Records Committee." },
                      { "code": "VT", "name": "Vermont", "lawName": "Vermont Public Records Act", "citation": "1 V.S.A. § 315 et seq.", "fullCitation": "the Vermont Public Records Act (1 V.S.A. § 315 et seq.)", "responseTime": "3 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "VA", "name": "Virginia", "lawName": "Virginia Freedom of Information Act", "citation": "Va. Code § 2.2-3700 et seq.", "fullCitation": "the Virginia Freedom of Information Act (Va. Code § 2.2-3700 et seq.)", "responseTime": "5 working days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to petition for mandamus or injunctive relief." },
                      { "code": "WA", "name": "Washington", "lawName": "Washington Public Records Act", "citation": "RCW 42.56.001 et seq.", "fullCitation": "the Washington Public Records Act (RCW 42.56.001 et seq.)", "responseTime": "5 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "WV", "name": "West Virginia", "lawName": "West Virginia Freedom of Information Act", "citation": "W. Va. Code § 29B-1-1 et seq.", "fullCitation": "the West Virginia Freedom of Information Act (W. Va. Code § 29B-1-1 et seq.)", "responseTime": "5 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to petition for mandamus." },
                      { "code": "WI", "name": "Wisconsin", "lawName": "Wisconsin Open Records Law", "citation": "Wis. Stat. § 19.31 et seq.", "fullCitation": "the Wisconsin Open Records Law (Wis. Stat. § 19.31 et seq.)", "responseTime": "Reasonable time", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." },
                      { "code": "WY", "name": "Wyoming", "lawName": "Wyoming Public Records Act", "citation": "Wyo. Stat. § 16-4-201 et seq.", "fullCitation": "the Wyoming Public Records Act (Wyo. Stat. § 16-4-201 et seq.)", "responseTime": "3 business days", "denialProcess": "Denials must cite specific exemptions and inform requester of right to seek court review." }
                    ];
                    this.templates = [
                      { "id": "police_report", "name": "Police Report", "subject": "Public Records Request - Police Report", "description": "I am requesting copies of all police reports, incident reports, and related documentation for incident number [INCIDENT_NUMBER] that occurred on [DATE] at approximately [TIME] at [LOCATION]. This request includes but is not limited to:\n\n• Initial incident report\n• Supplemental reports\n• Witness statements\n• Photographs taken at the scene\n• Audio or video recordings\n• Evidence logs\n• Officer notes or field reports\n• Any correspondence related to this incident", "expedited": false, "feeWaiver": false, "publicInterest": false },
                      { "id": "animal_welfare", "name": "Animal Welfare Records", "subject": "Public Records Request - Animal Control/Welfare Records", "description": "I am requesting records related to animal control activities and welfare investigations for the period from [START_DATE] to [END_DATE]. This request includes:\n\n• Animal control reports and incident logs\n• Investigation reports regarding animal welfare complaints\n• Citations issued for animal-related violations\n• Correspondence with animal welfare organizations\n• Adoption and euthanasia records\n• Licensing and registration data\n• Budget and expenditure records for animal control services\n• Policies and procedures for animal control operations", "expedited": false, "feeWaiver": true, "publicInterest": true },
                      { "id": "government_contracts", "name": "Government Contracts", "subject": "Public Records Request - Government Contracts and Procurement", "description": "I am requesting records related to government contracts and procurement activities for the period from [START_DATE] to [END_DATE]. This request includes:\n\n• All contracts and agreements exceeding $[AMOUNT]\n• Bid documents and procurement records\n• Vendor correspondence and communications\n• Payment records and invoices\n• Contract modifications and amendments\n• Performance evaluations and compliance reports\n• Procurement policies and procedures\n• Conflict of interest disclosures\n• Emergency procurement justifications", "expedited": false, "feeWaiver": true, "publicInterest": true },
                      { "id": "financial_records", "name": "Financial Records", "subject": "Public Records Request - Financial Records and Budget Documents", "description": "I am requesting financial records and budget-related documents for fiscal year [FISCAL_YEAR]. This request includes:\n\n• Annual budget documents and amendments\n• Financial statements and audit reports\n• Expenditure records by department/category\n• Revenue reports and tax collection data\n• Grant applications and awards\n• Investment portfolio statements\n• Debt service schedules\n• Employee compensation records\n• Vendor payment registers", "expedited": false, "feeWaiver": true, "publicInterest": true },
                      { "id": "meeting_records", "name": "Meeting Records", "subject": "Public Records Request - Meeting Minutes and Records", "description": "I am requesting records related to public meetings and deliberations for the period from [START_DATE] to [END_DATE]. This request includes:\n\n• Meeting minutes and transcripts\n• Agendas and supporting materials\n• Audio or video recordings of meetings\n• Correspondence between officials regarding meeting topics\n• Voting records and roll call votes\n• Executive session documentation (if legally accessible)\n• Public comment submissions\n• Presentation materials and handouts", "expedited": false, "feeWaiver": true, "publicInterest": true },
                      { "id": "employment_records", "name": "Employment Records", "subject": "Public Records Request - Employment and Personnel Records", "description": "I am requesting employment-related records for the period from [START_DATE] to [END_DATE]. This request includes:\n\n• Job descriptions and classifications\n• Salary schedules and compensation data\n• Organizational charts and staffing reports\n• Hiring and promotion records\n• Training and professional development records\n• Grievance and disciplinary records\n• Performance evaluation summaries\n• Overtime and leave records\n• Employment policies and procedures", "expedited": false, "feeWaiver": true, "publicInterest": true },
                      { "id": "property_records", "name": "Property Records", "subject": "Public Records Request - Property and Real Estate Records", "description": "I am requesting records related to property and real estate transactions for the period from [START_DATE] to [END_DATE]. This request includes:\n\n• Property acquisition and disposal records\n• Appraisal and valuation reports\n• Lease agreements and rental records\n• Maintenance and repair records\n• Property tax assessments\n• Zoning and land use decisions\n• Environmental assessments\n• Construction and renovation contracts\n• Property insurance records", "expedited": false, "feeWaiver": true, "publicInterest": true },
                      { "id": "permits_licenses", "name": "Permits and Licenses", "subject": "Public Records Request - Permits and Licensing Records", "description": "I am requesting records related to permits and licenses issued for the period from [START_DATE] to [END_DATE]. This request includes:\n\n• Building permits and construction records\n• Business licenses and registrations\n• Zoning permits and variances\n• Environmental permits and compliance records\n• Inspection reports and violations\n• Permit application documents\n• Fee schedules and payment records\n• Appeals and hearing records\n• Enforcement actions and penalties", "expedited": false, "feeWaiver": false, "publicInterest": false }
                    ];
                },

                // --- LANGUAGE & THEME --- //
                initLanguage() {
                    const savedLang = localStorage.getItem('appLanguage') || 'en';
                    this.setLang(savedLang);
                },
                setLang(lang) {
                    this.currentLang = this.locales[lang] ? lang : 'en';
                    localStorage.setItem('appLanguage', this.currentLang);
                    document.documentElement.lang = this.currentLang;
                },
                t(key, fallback = '') {
                    return this.locales[this.currentLang]?.[key] || fallback || key;
                },
                initDarkMode() {
                    const savedTheme = localStorage.getItem('darkMode');
                    this.darkMode = savedTheme ? savedTheme === 'true' : window.matchMedia('(prefers-color-scheme: dark)').matches;
                     this.$watch('darkMode', val => localStorage.setItem('darkMode', val));
                },
                toggleDarkMode() { this.darkMode = !this.darkMode; },

                // --- DYNAMIC PREVIEW --- //
                updatePreview(){
                    // The preview is now handled reactively by x-html, so this method is a placeholder
                },

                generateLetterHTML() {
                    const h = (tag, content, classes = '') => `<${tag} class="${classes}">${content}</${tag}>`;
                    let html = '';
                    html += h('div', this.getCurrentDate(), 'mb-8 text-right');
                    html += `<div class="mb-8">
                                ${this.form.agencyContact ? h('div', this.form.agencyContact) : ''}
                                ${this.form.agencyName ? h('div', this.form.agencyName) : ''}
                                ${this.form.agencyDepartment ? h('div', this.form.agencyDepartment) : ''}
                                ${this.form.agencyAddress ? this.form.agencyAddress.replace(/\n/g, '<br>') : ''}
                            </div>`;
                    html += h('div', `<strong>RE: ${this.form.subject || '[Subject Line]'}</strong>`, 'mb-6');
                    html += h('div', `Dear ${this.form.agencyContact || 'Records Officer'},`, 'mb-4');
                    html += h('div', `I am writing to request access to public records under <span class="font-semibold">${this.getStateCitation()}</span>. ${this.form.requesterOrganization ? `I am making this request on behalf of ${this.form.requesterOrganization}.` : ''}`, 'mb-4');
                    html += h('div', '<strong>Specifically, I am requesting the following records:</strong>', 'mb-4');
                    html += h('div', this.form.recordsDescription.replace(/\n/g, '<br>') || '[Please describe the records...]', 'mb-4 pl-4 border-l-2 border-gray-300 dark:border-gray-600');
                    if(this.getDateRangeText()) html += h('div', `<strong>Date Range:</strong> ${this.getDateRangeText()}`, 'mb-4');
                    if(this.form.preferredFormat) html += h('div', `I would prefer to receive these records in <strong>${this.form.preferredFormat}</strong> format.`, 'mb-4');
                    if(this.form.feeWaiverRequest) html += h('div', 'I request that any fees be waived as this information is sought in the public interest.', 'mb-4');
                    if(this.form.expeditedProcessing) html += h('div', 'I request expedited processing of this request.', 'mb-4');
                    if(this.form.additionalNotes) html += h('div', this.form.additionalNotes, 'mb-4');
                    html += h('div', this.getLegalRequirements(), 'mb-4 text-sm text-gray-600 dark:text-gray-400');
                    html += h('div', `If you have any questions, please contact me at ${this.form.requesterEmail || '[email]'}${this.form.requesterPhone ? ` or ${this.form.requesterPhone}` : ''}.`, 'mb-4');
                    html += h('div', 'Thank you for your time and consideration.', 'mb-6');
                    html += h('div', 'Sincerely,', 'mb-4');
                    html += `<div class="mt-12">
                                <div>${this.form.requesterName || '[Your Name]'}</div>
                                ${this.form.requesterOrganization ? `<div>${this.form.requesterOrganization}</div>` : ''}
                            </div>`;
                    return html;
                },

                // --- Event Handlers & Actions --- //
                onStateChange() { this.selectedLaw = this.form.state ? this.laws.find(l => l.code === this.form.state) : null; },
                applyTemplate() {
                    if (!this.selectedTemplate) return;
                    const isCustom = this.selectedTemplate.startsWith('custom_');
                    const templateId = isCustom ? this.selectedTemplate.replace('custom_', '') : this.selectedTemplate;
                    const source = isCustom ? this.customTemplates : this.templates;
                    const template = source.find(t => t.id === templateId);
        
                    if (template) {
                        this.form.subject = template.subject;
                        this.form.recordsDescription = template.recordsDescription || template.description;
                        this.form.expeditedProcessing = template.expeditedProcessing || template.expedited || false;
                        this.form.feeWaiverRequest = template.feeWaiverRequest || template.feeWaiver || false;
                        this.form.additionalNotes = template.additionalNotes || '';
                        if(template.preferredFormat) this.form.preferredFormat = template.preferredFormat;
                        this.showNotification(`Applied template: ${this.t(template.id, template.name)}`, 'success');
                    }
                },
                copyToClipboard() {
                    const letterText = document.getElementById('letterPreviewContainer').innerText;
                    navigator.clipboard.writeText(letterText).then(() => this.showNotification('Letter copied!', 'success'), () => this.showNotification('Copy failed.', 'error'));
                },
                exportAsText() {
                    const letterText = document.getElementById('letterPreviewContainer').innerText;
                    const blob = new Blob([letterText], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `public-records-request-${this.getCurrentDateForFilename()}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                exportAsPDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'pt',
                        format: 'letter'
                    });
                    
                    doc.setFont('Times-Roman');
                    
                    const content = document.getElementById('letterPreview');
                    
                    doc.html(content, {
                        callback: function (doc) {
                            doc.save(`public-records-request-${this.getCurrentDateForFilename()}.pdf`);
                        }.bind(this),
                        x: 10,
                        y: 10,
                        width: 595, // A4 width in points
                        windowWidth: content.scrollWidth
                    });
                     this.showNotification('PDF generation started...', 'info');
                },
                confirmStartOver() {
                    this.showConfirmation('Start Over?', 'Are you sure you want to clear all form data?', () => {
                        this.resetForm();
                        this.showNotification('Form has been cleared.', 'success');
                    });
                },

                // --- Utility Functions --- //
                getDateRangeText() {
                    const { dateFrom, dateTo } = this.form;
                    if (dateFrom && dateTo) return `${this.formatDate(dateFrom)} to ${this.formatDate(dateTo)}`;
                    if (dateFrom) return `From ${this.formatDate(dateFrom)}`;
                    if (dateTo) return `Through ${this.formatDate(dateTo)}`;
                    return '';
                },
                getStateCitation() { return this.selectedLaw?.fullCitation || 'the applicable state public records law'; },
                getLegalRequirements() {
                    if (!this.selectedLaw) return 'Please respond to this request within the timeframe required by law. If any portion of this request is denied, please cite the specific legal authority for the denial.';
                    return `Under ${this.selectedLaw.fullCitation}, you are required to respond within ${this.selectedLaw.responseTime}. ${this.selectedLaw.denialProcess}`;
                },
                showConfirmation(title, body, onConfirmAction, confirmType = 'danger') {
                    this.confirmModal = {
                        open: true, title, body, onConfirm: onConfirmAction,
                        confirmText: confirmType === 'danger' ? 'Confirm' : 'OK',
                        confirmClass: confirmType === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700',
                    };
                },
                showNotification(message, type = 'success') {
                    const id = this.notificationCounter++;
                    this.notifications.push({ id, message, type, visible: true });
                    setTimeout(() => {
                        const notification = this.notifications.find(n => n.id === id);
                        if (notification) notification.visible = false;
                        setTimeout(() => this.notifications = this.notifications.filter(n => n.id !== id), 500);
                    }, 5000);
                },
                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString + 'T00:00:00');
                    return date.toLocaleDateString(this.currentLang, { year: 'numeric', month: 'long', day: 'numeric' });
                },
                getCurrentDate() { return new Date().toLocaleDateString(this.currentLang, { year: 'numeric', month: 'long', day: 'numeric' }); },
                getCurrentDateForFilename() { return new Date().toISOString().split('T')[0]; },
                
                // --- Custom Template Functions --- //
                openTemplateWizard() { this.resetCustomTemplate(); this.showTemplateWizard = true; },
                closeTemplateWizard() { this.showTemplateWizard = false; },
                resetCustomTemplate() {
                    this.customTemplate = {
                        id: '', name: '', subject: '', recordsDescription: '',
                        additionalNotes: '', expeditedProcessing: false, feeWaiverRequest: false
                    };
                },
                saveCustomTemplate() {
                    if (!this.customTemplate.name.trim() || !this.customTemplate.subject.trim() || !this.customTemplate.recordsDescription.trim()) {
                        this.showNotification('Template Name, Subject, and Description are required.', 'error');
                        return;
                    }
                    const isEditing = !!this.customTemplate.id;
                    if (isEditing) {
                        const index = this.customTemplates.findIndex(t => t.id === this.customTemplate.id);
                        if (index > -1) this.customTemplates[index] = { ...this.customTemplate };
                    } else {
                        this.customTemplate.id = Date.now().toString();
                        this.customTemplates.push({ ...this.customTemplate });
                    }
                    this.saveCustomTemplatesToStorage();
                    this.showNotification(isEditing ? 'Template updated!' : 'Template saved!', 'success');
                    this.closeTemplateWizard();
                },
                editCustomTemplate(id) {
                    const template = this.customTemplates.find(t => t.id === id);
                    if (template) {
                        this.customTemplate = { ...template };
                        this.showTemplateWizard = true;
                    }
                },
                deleteCustomTemplate(id) {
                    this.showConfirmation('Delete Template?', 'This cannot be undone.', () => {
                        this.customTemplates = this.customTemplates.filter(t => t.id !== id);
                        this.saveCustomTemplatesToStorage();
                        if (this.selectedTemplate === `custom_${id}`) this.selectedTemplate = '';
                        this.showNotification('Template deleted.', 'success');
                    });
                },
                loadCustomTemplatesFromStorage() {
                    const saved = localStorage.getItem('customTemplates');
                    this.customTemplates = saved ? JSON.parse(saved) : [];
                },
                saveCustomTemplatesToStorage() {
                    localStorage.setItem('customTemplates', JSON.stringify(this.customTemplates));
                },
            }));
        });
    </script>
</body>
</html>
