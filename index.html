<!DOCTYPE html>
<html lang="en" x-data="publicRecordsApp" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Records Request Generator</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <!-- Fonts and Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/custom.css">
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; }
        .form-legend { @apply text-xl font-bold mb-4 text-gray-800 flex items-center; }
        .form-label { @apply block text-sm font-medium mb-1 text-gray-600; }
        .form-input, .form-select, .form-textarea { @apply w-full px-4 py-2 border rounded-lg bg-gray-50 border-gray-300 text-gray-900 placeholder-gray-400 transition-all duration-200 shadow-sm; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { @apply ring-2 ring-blue-500 border-transparent shadow-lg; }
        .action-button { @apply px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg text-sm font-semibold text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-offset-2; }
        .letter-content { font-family: 'Tinos', 'Times New Roman', serif; line-height: 1.7; }
        .notification { animation: slideInRight 0.5s ease-out forwards, fadeOut 0.5s ease-in forwards 4.5s; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar-container { @apply w-full bg-gray-200 rounded-full h-2.5 mb-4; }
        .progress-bar { @apply bg-blue-600 h-2.5 rounded-full transition-all duration-500; }
    </style>
</head>
<body x-cloak class="bg-gray-100 text-gray-900">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-3">
                    <i class="fas fa-file-invoice text-2xl sm:text-3xl text-blue-600"></i>
                    <div>
                        <h1 class="text-lg sm:text-2xl font-bold" x-text="t('appTitle', 'Public Records Request Generator')"></h1>
                        <p class="hidden sm:block text-sm text-gray-500" x-text="t('appSubtitle', 'Craft professional requests...')"></p>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="relative">
                        <select x-model="currentLang" @change="setLang($event.target.value)" class="form-select !w-auto !py-2 !px-3 sm:!py-2.5 sm:!pl-10 sm:!pr-5 text-sm appearance-none">
                            <option value="en">EN</option>
                            <option value="es">ES</option>
                        </select>
                        <i class="hidden sm:block fas fa-globe absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button @click="confirmStartOver()" class="action-button bg-red-600 hover:bg-red-700 focus:ring-red-500">
                        <i class="fas fa-sync-alt sm:mr-2"></i><span class="hidden sm:inline" x-text="t('startOver', 'Start Over')"></span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-10">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <!-- Form Section -->
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 space-y-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-900" x-text="t('requestDetails', 'Request Details')"></h2>
                    <div class="text-sm font-medium text-gray-600">
                        <span x-text="t('progress', 'Progress')"></span>: <span x-text="`${progress}%`"></span>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" :style="`width: ${progress}%`"></div>
                </div>

                <fieldset>
                    <legend class="form-legend"><i class="fas fa-landmark mr-3 text-blue-500"></i><span x-text="t('jurisdiction', 'Jurisdiction')"></span></legend>
                    <label for="state-select" class="form-label" x-text="t('selectState', 'Select Your State (Required)')"></label>
                    <select id="state-select" x-model="form.state" @change="onStateChange()" class="form-select">
                        <option value="" x-text="t('chooseState', 'Choose your state...')"></option>
                        <template x-for="law in laws" :key="law.code"><option :value="law.code" x-text="`${law.name} (${law.code})`"></option></template>
                    </select>
                </fieldset>
                
                <!-- State Law Quick Guide -->
                <div x-show="selectedLaw" x-collapse>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <h4 class="font-bold text-lg text-blue-800 flex items-center"><i class="fas fa-gavel mr-2"></i><span x-text="`${selectedLaw?.name} ${t('lawGuide', 'Law Quick Guide')}`"></span></h4>
                        <div class="mt-2 space-y-2 text-sm text-blue-700">
                            <p><strong><span x-text="t('citation', 'Citation')"></span>:</strong> <span x-text="selectedLaw?.citation"></span></p>
                            <p><strong><span x-text="t('responseTime', 'Response Time')"></span>:</strong> <span x-text="selectedLaw?.responseTime"></span></p>
                            <p><strong><span x-text="t('denialProcess', 'Denial/Appeal Process')"></span>:</strong> <span x-text="selectedLaw?.denialProcess"></span></p>
                        </div>
                    </div>
                </div>

                <fieldset>
                    <legend class="form-legend"><i class="fas fa-file-lines mr-3 text-purple-500"></i><span x-text="t('requestTemplate', 'Request Template')"></span></legend>
                    <div class="flex flex-col sm:flex-row items-center justify-between mb-3 gap-3">
                        <label for="template-select" class="form-label w-full sm:w-auto" x-text="t('quickStartTemplates', 'Quick Start Templates')"></label>
                        <button @click="openTemplateWizard()" class="w-full sm:w-auto action-button bg-purple-600 hover:bg-purple-700 text-sm focus:ring-purple-500">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i><span x-text="t('createCustom', 'Create Custom')"></span>
                        </button>
                    </div>
                    <select id="template-select" x-model="selectedTemplate" @change="applyTemplate()" class="form-select">
                        <option value="" x-text="t('selectTemplate', 'Select a template...')"></option>
                        <optgroup :label="t('builtInTemplates', 'Built-in Templates')">
                            <template x-for="template in templates" :key="template.id"><option :value="template.id" x-text="t(template.id, template.name)"></option></template>
                        </optgroup>
                        <template x-if="customTemplates.length > 0">
                            <optgroup :label="t('myCustomTemplates', 'My Custom Templates')">
                                <template x-for="template in customTemplates" :key="template.id"><option :value="'custom_' + template.id" x-text="template.name"></option></template>
                            </optgroup>
                        </template>
                    </select>
                     <div class="mt-3">
                        <button @click="getRecordSuggestions()" :disabled="!selectedTemplate || isLoading" class="w-full action-button bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500 disabled:bg-indigo-300 disabled:cursor-not-allowed flex items-center justify-center">
                            <span x-show="!isLoading">âœ¨ <span x-text="t('getAISuggestions', 'Get AI Suggestions')"></span></span>
                            <span x-show="isLoading" class="flex items-center"><div class="spinner mr-2"></div> <span x-text="t('loading', 'Loading...')"></span></span>
                        </button>
                    </div>
                </fieldset>
                
                <fieldset class="pt-6 sm:pt-8 border-t-2 border-gray-200">
                    <legend class="form-legend"><i class="fas fa-paragraph mr-3 text-orange-500"></i><span x-text="t('recordsDescription', 'Records Description')"></span></legend>
                    <label for="recordsDescription" class="form-label" x-text="t('describeRecords', 'Describe the records...')"></label>
                    <textarea id="recordsDescription" x-model="form.recordsDescription" :placeholder="t('describeRecordsPlaceholder', 'e.g., All emails...')" rows="8" class="form-textarea"></textarea>
                    <div class="mt-3">
                        <button @click="refineRequestDescription()" :disabled="!form.recordsDescription.trim() || isLoading" class="w-full action-button bg-orange-500 hover:bg-orange-600 focus:ring-orange-400 disabled:bg-orange-300 disabled:cursor-not-allowed flex items-center justify-center">
                            <span x-show="!isLoading">âœ¨ <span x-text="t('refineWithAI', 'Refine with AI')"></span></span>
                            <span x-show="isLoading" class="flex items-center"><div class="spinner mr-2"></div> <span x-text="t('loading', 'Loading...')"></span></span>
                        </button>
                    </div>
                </fieldset>

                <fieldset class="pt-6 sm:pt-8 border-t-2 border-gray-200">
                    <legend class="form-legend"><i class="fas fa-user-edit mr-3 text-green-500"></i><span x-text="t('yourInformation', 'Your Information')"></span></legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="requesterName" class="form-label" x-text="t('fullName', 'Full Name *')"></label><input id="requesterName" type="text" x-model="form.requesterName" :placeholder="t('fullNamePlaceholder', 'John Doe')" class="form-input" required></div>
                        <div><label for="requesterEmail" class="form-label" x-text="t('emailAddress', 'Email Address *')"></label><input id="requesterEmail" type="email" x-model="form.requesterEmail" :placeholder="t('emailAddressPlaceholder', 'john@example.com')" class="form-input" required></div>
                        <div><label for="requesterPhone" class="form-label" x-text="t('phoneNumber', 'Phone Number')"></label><input id="requesterPhone" type="tel" x-model="form.requesterPhone" :placeholder="t('phoneNumberPlaceholder', '(555) 123-4567')" class="form-input"></div>
                        <div><label for="requesterOrganization" class="form-label" x-text="t('organization', 'Organization')"></label><input id="requesterOrganization" type="text" x-model="form.requesterOrganization" :placeholder="t('organizationPlaceholder', 'News Organization')" class="form-input"></div>
                    </div>
                    <div class="mt-6"><label for="requesterAddress" class="form-label" x-text="t('mailingAddress', 'Mailing Address')"></label><textarea id="requesterAddress" x-model="form.requesterAddress" :placeholder="t('mailingAddressPlaceholder', '123 Main St...')" rows="3" class="form-textarea"></textarea></div>
                </fieldset>

                <fieldset class="pt-6 sm:pt-8 border-t-2 border-gray-200">
                    <legend class="form-legend"><i class="fas fa-cogs mr-3 text-gray-500"></i><span x-text="t('options', 'Options')"></span></legend>
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="feeWaiverRequest" type="checkbox" x-model="form.feeWaiverRequest" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="feeWaiverRequest" class="font-medium text-gray-700" x-text="t('requestFeeWaiver', 'Request a Fee Waiver')"></label>
                                <p class="text-gray-500" x-text="t('feeWaiverDescription', 'Check this if...')"></p>
                            </div>
                        </div>
                        <button @click="generateFeeWaiverText()" :disabled="!form.feeWaiverRequest || isLoading" class="w-full sm:w-auto action-button bg-teal-600 hover:bg-teal-700 focus:ring-teal-500 disabled:bg-teal-300 disabled:cursor-not-allowed flex items-center justify-center text-xs">
                            <span x-show="!isLoading">âœ¨ <span x-text="t('generateWaiverText', 'Generate Waiver Text with AI')"></span></span>
                            <span x-show="isLoading" class="flex items-center"><div class="spinner mr-2"></div> <span x-text="t('loading', 'Loading...')"></span></span>
                        </button>
                    </div>
                </fieldset>
            </div>

            <!-- Preview Section -->
            <div class="lg:sticky top-28 h-fit">
                <div class="rounded-2xl shadow-xl p-6 sm:p-8 bg-white">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-900" x-text="t('previewExport', 'Preview & Export')"></h2>
                        <div class="flex gap-2 sm:gap-3">
                            <button @click="copyToClipboard()" :disabled="progress < 100" :title="t('copyAsText', 'Copy as Text')" class="action-button bg-blue-600 hover:bg-blue-700 focus:ring-blue-500 disabled:bg-blue-300"><i class="fas fa-copy"></i></button>
                            <button @click="exportAsText()" :disabled="progress < 100" :title="t('downloadAsTXT', 'Download as TXT')" class="action-button bg-green-600 hover:bg-green-700 focus:ring-green-500 disabled:bg-green-300"><i class="fas fa-file-alt"></i></button>
                            <button @click="exportAsPDF()" :disabled="progress < 100" :title="t('exportAsPDF', 'Export as PDF')" class="action-button bg-red-600 hover:bg-red-700 focus:ring-red-500 disabled:bg-red-300"><i class="fas fa-file-pdf"></i></button>
                        </div>
                    </div>
                    
                    <div id="letterPreviewContainer" class="border-2 rounded-lg h-[60vh] lg:h-[75vh] overflow-y-auto bg-gray-50 border-gray-200">
                        <div id="letterPreview" class="p-6 sm:p-8 text-gray-800">
                            <div class="letter-content" x-html="generateLetterHTML()">
                                <!-- Letter content is dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification Area -->
    <div aria-live="assertive" class="fixed inset-0 flex items-end px-4 py-6 pointer-events-none sm:p-6 sm:items-start z-50">
        <div class="w-full flex flex-col items-center space-y-4 sm:items-end">
            <template x-for="notification in notifications" :key="notification.id">
                <div x-show="notification.visible" x-transition:enter="transform ease-out duration-300 transition" x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2" x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0" x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas" :class="{ 'fa-check-circle text-green-400': notification.type === 'success', 'fa-exclamation-circle text-red-400': notification.type === 'error', 'fa-info-circle text-blue-400': notification.type === 'info' }"></i>
                            </div>
                            <div class="ml-3 w-0 flex-1 pt-0.5">
                                <p class="text-sm font-medium text-gray-900" x-text="notification.message"></p>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex">
                                <button @click="notification.visible = false" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <span class="sr-only">Close</span>
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div x-show="confirmModal.open" x-cloak class="fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="confirmModal.open" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div x-show="confirmModal.open" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title" x-text="confirmModal.title"></h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500" x-text="confirmModal.body"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="confirmModal.onConfirm(); confirmModal.open = false" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white sm:ml-3 sm:w-auto sm:text-sm" :class="confirmModal.confirmClass" x-text="confirmModal.confirmText"></button>
                    <button @click="confirmModal.open = false" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Application Script -->
    <script src="js/app.js" defer></script>
</body>
</html>
